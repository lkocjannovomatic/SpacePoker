# SpacePoker

A single-player, offline desktop poker game (No-Limit Texas Hold'em) featuring LLM-powered NPCs with unique personalities. Built with Godot Engine 4.5 and powered by a local Phi-3-mini language model, SpacePoker creates opponents with distinct backstories that drive their gameplay strategies and conversational styles.

**Core Innovation:** Each NPC has a unique, LLM-generated backstory that extracts personality factors (aggression, bluffing, risk_aversion). These factors influence a rule-based game strategy, making each opponent's playstyle discoverable and consistent. Players can engage in real-time text conversations with NPCs, whose dialogue is generated by the local LLM based on their established personality.

This project serves as an educational tool to gain hands-on experience integrating LLM technology into a functional game application while exploring Godot's signal-based architecture and state machine patterns.

## Table of Contents
- [Project Description](#spacepoker)
- [Table of Contents](#table-of-contents)
- [Tech Stack](#tech-stack)
- [Getting Started Locally](#getting-started-locally)
- [Project Structure](#project-structure)
- [Project Scope](#project-scope)
- [Key Features](#key-features)
- [Project Status](#project-status)
- [How to Play](#how-to-play)
- [License](#license)

## Tech Stack
- **Game Engine:** [Godot Engine 4.5](https://godotengine.org/) (GDScript)
- **LLM Integration:** [Godot LLM Addon](https://github.com/Adriankhl/godot-llm) (GDLlama)
- **Language Model:** Phi-3-mini-4k-instruct-q4 (Local GGUF)
- **Testing Framework:** [GdUnit4](https://github.com/MikeSchulze/gdUnit4) for unit and integration tests
- **Audio:** Godot's built-in audio system with background music and SFX

## Getting Started Locally

### Prerequisites
- A recent stable version of the Godot Engine.
- A GGUF-compatible LLM model file. The project is configured for `Phi-3-mini-4k-instruct-q4.gguf`.

### Installation & Setup
1.  **Clone the repository:**
    ```sh
    git clone <repository-url>
    cd SpacePoker
    ```
2.  **Download the Language Model:**
    - Obtain the `Phi-3-mini-4k-instruct-q4.gguf` model from Hugging Face or similar platforms.
    - Place the downloaded model file inside the `llms/` directory in the project root.
    - The file should be named exactly: `Phi-3-mini-4k-instruct-q4.gguf`

3.  **Open the project in Godot:**
    - Download and install [Godot Engine 4.5](https://godotengine.org/download) or later.
    - Open the Godot Engine editor.
    - Click "Import" and select the `project.godot` file from the cloned repository.
    - Wait for Godot to import all assets and initialize the project.

4.  **Run the project:**
    - Once the project is loaded, click the "Play" button (or press F5) to run the game.
    - The game will start at the Start Screen where you can generate NPCs and begin playing.

### Running Tests
The project includes a comprehensive test suite using GdUnit4:

```powershell
# Run all tests
.\run_tests.ps1

# Run specific test file
.\run_tests.ps1 tests/unit/test_poker_engine.gd
```

Test reports are automatically generated in the `reports/` directory with HTML output.

## Project Structure
The project follows a standard Godot project structure with modular organization:
```
/
├── addons/
│   ├── gdUnit4/           # Unit testing framework
│   └── godot_llm/         # LLM integration addon (GDLlama)
├── assets/                # Game assets
│   ├── audio/
│   │   ├── music/         # Background music files
│   │   └── sfx/           # Sound effects
│   ├── backgrounds/       # Table and casino backgrounds
│   ├── cards/             # 52 poker card images + card back
│   ├── fonts/             # UI fonts
│   └── ui/                # UI elements and icons
├── docs/                  # Project documentation
│   ├── prd.md             # Product Requirements Document
│   ├── tech-stack.md      # Technology stack decisions
│   └── *.md               # Implementation plans and summaries
├── llms/                  # Local LLM model files
│   └── Phi-3-mini-4k-instruct-q4.gguf
├── prompts/               # LLM prompt templates
│   ├── npc_generation.txt      # NPC backstory generation
│   ├── chat_response.txt       # In-game chat responses
│   └── chat_opening_line.txt   # Match opening lines
├── reports/               # GdUnit4 test reports (HTML)
├── saves/                 # JSON persistence files
│   ├── slot_0.json to slot_7.json  # NPC data
│   └── player_stats.json           # Win/loss statistics
├── scenes/                # Godot scene files (.tscn)
│   ├── StartScreen.tscn   # Main menu with NPC management
│   ├── GameView.tscn      # Poker table interface
│   ├── StatisticsScreen.tscn  # Win/loss records
│   ├── Board.tscn         # Poker table component
│   ├── Chat.tscn          # Chat interface component
│   ├── Card.tscn          # Card visual component
│   ├── NPCSlot.tscn       # Reusable NPC slot component
│   └── Dialog.tscn        # Confirmation dialog component
├── scripts/               # GDScript files (.gd)
│   ├── autoload/          # Global singleton scripts
│   │   ├── GameManager.gd # Game state and data persistence
│   │   ├── GameState.gd   # Poker state machine
│   │   ├── LLMClient.gd   # LLM communication wrapper
│   │   └── AudioManager.gd # Audio playback manager
│   ├── game_view/         # Poker game logic
│   │   ├── PokerEngine.gd # Texas Hold'em engine
│   │   ├── HandEvaluator.gd # Poker hand evaluation
│   │   ├── Deck.gd        # Card deck management
│   │   ├── NPC_AI.gd      # Rule-based NPC strategy
│   │   ├── GameView.gd    # Main game controller
│   │   ├── Board.gd       # Poker table UI logic
│   │   ├── Chat.gd        # Chat interface logic
│   │   ├── Card.gd        # Card component script
│   │   └── CardData.gd    # Card data structure
│   └── start_screen/      # Start screen logic
│       ├── StartScreen.gd # Main menu controller
│       ├── NPCSlot.gd     # NPC slot management
│       ├── NPCGenerator.gd # NPC generation logic
│       ├── StatisticsScreen.gd # Statistics display
│       └── Dialog.gd      # Dialog controller
├── tests/                 # GdUnit4 test suite
│   ├── unit/              # Unit tests
│   │   ├── test_poker_engine.gd
│   │   ├── test_hand_evaluator.gd
│   │   ├── test_deck.gd
│   │   └── test_helpers.gd
│   ├── integration/       # Integration tests
│   │   └── test_game_flow.gd
│   └── utils/             # Test utilities
├── themes/                # UI theme resources
│   └── main_theme.tres    # Global UI theme
├── project.godot          # Main Godot project file
├── run_tests.ps1          # PowerShell test runner script
└── README.md              # This file
```

## Project Scope

### In Scope (MVP)
- ✅ A fully functional, single-player, offline desktop application for Windows.
- ✅ Implementation of one poker variant: No-Limit Texas Hold'em.
- ✅ A maximum of 8 generated NPC opponents.
- ✅ NPC personality driven by three specific factors (`aggression`, `bluffing`, `risk_aversion`).
- ✅ Real-time chat with NPCs powered by a local LLM.
- ✅ Persistence of NPC profiles, statistics, and conversation summaries in local JSON files.
- ✅ Comprehensive test suite with GdUnit4 (unit and integration tests).
- 🚧 Complete end-to-end gameplay loop with polish and refinement.

### Out of Scope (MVP)
- Web, mobile, or console versions.
- Online or local multiplayer functionality.
- User accounts, authentication, or cloud-based saves.
- Saving or loading a game that is in progress.
- Dynamic or increasing blind levels (tournament mode).
- AI-powered generation of visual assets (e.g., NPC avatars, card designs).
- In-game currency, microtransactions, or monetization.
- Multiple poker variants (Omaha, 7-Card Stud, etc.).

### Technical Architecture Highlights
- **Modular Design**: Separation of concerns with autoload singletons, reusable components, and signal-based communication.
- **State Machine Pattern**: PokerEngine and GameState use explicit state enums for predictable game flow.
- **LLM Separation**: LLM generates personality and chat only; poker strategy is rule-based for reliability.
- **Async Operations**: Non-blocking LLM calls allow gameplay to continue during AI processing.
- **Test Coverage**: Core poker logic is thoroughly tested to ensure correctness.

## Key Features

### 🎭 LLM-Powered NPCs with Unique Personalities
- Each NPC has a unique backstory generated by Phi-3-mini LLM
- Personality factors extracted from backstory influence gameplay strategy:
  - **Aggression** (0.0-1.0): Affects betting frequency and size
  - **Bluffing** (0.0-1.0): Influences bluff probability
  - **Risk Aversion** (0.0-1.0): Determines fold thresholds
- Rule-based AI uses personality factors for strategic decisions (NOT LLM-driven gameplay)

### 💬 Real-Time Conversational AI
- Chat with NPCs during matches using natural language
- NPCs respond in-character based on their personality and backstory
- Asynchronous chat system allows poker moves while waiting for AI responses
- Conversation history tracked across multiple matches
- Opening lines delivered at match start to introduce NPC character

### 🃏 Complete Texas Hold'em Implementation
- Standard No-Limit Texas Hold'em rules
- Full betting rounds: Pre-flop, Flop, Turn, River
- Accurate hand evaluation (High Card to Royal Flush)
- All-in scenarios with side pot management
- Fixed match structure: 1000 credits, 10/20 blinds, play to elimination

### 📊 Persistent Progress & Statistics
- Win/loss records tracked per NPC
- Match history and conversation logs saved locally
- Portable JSON-based save system (no database required)
- Up to 8 NPC slots for diverse opponents

### 🎨 Polished UI & UX
- Clean, space-themed casino interface
- Visual card displays with suit/rank sprites
- Betting slider with min/max constraints
- Background music and sound effects
- Tabbed chat interface (current match vs. history)

## Project Status

### Current Implementation Status
This project is currently **in active development**. The following components have been implemented:

#### ✅ Completed Features
- **Start Screen & NPC Management**
  - 8-slot NPC grid interface with generation, deletion, and selection
  - Reusable NPCSlot component with state management (Empty/Generating/Occupied)
  - Global dialog system for confirmations and error messages
  - Statistics screen with win/loss records
  - Background music and sound effects integration

- **LLM Integration**
  - LLMClient autoload singleton wrapping godot-llm addon
  - Dual model configuration (NPC generation vs. chat optimization)
  - Phi-3-mini-4k-instruct-q4 model support
  - Async LLM call handling with signal-based responses
  - Three prompt templates: NPC generation, chat response, opening line

- **Core Poker Engine**
  - Complete Texas Hold'em game logic (PokerEngine.gd)
  - Hand evaluator with all poker hand rankings
  - Deck management and card shuffling
  - Betting rounds (pre-flop, flop, turn, river)
  - All-in scenarios and side pot logic
  - State machine architecture for game flow

- **Game View Components**
  - Board component with card display and betting controls
  - Chat interface with real-time NPC conversation
  - Chat history tracking across matches
  - Asynchronous chat (player can make poker moves while waiting for responses)
  - Card visual components with sprite integration

- **NPC AI System**
  - Rule-based strategy using personality factors (aggression, bluffing, risk_aversion)
  - Decision-making based on hand strength and game context
  - Personality-driven behavior patterns
  - NPC generator with LLM-based backstory creation

- **Data Persistence**
  - JSON-based save system in `saves/` folder
  - 8 NPC slot files (slot_0.json to slot_7.json)
  - Player statistics tracking (player_stats.json)
  - Portable saves (located next to executable)

- **Testing Infrastructure**
  - GdUnit4 integration for unit and integration tests
  - Test coverage for PokerEngine, HandEvaluator, and Deck
  - PowerShell test runner script (run_tests.ps1)
  - HTML test reports generation

#### 🚧 In Progress / Pending
- **Game View Polish**
  - Visual feedback and animations for card dealing
  - Improved UI/UX for betting controls
  - Enhanced showdown presentation

- **NPC Personality Refinement**
  - Fine-tuning personality factor extraction from backstories
  - Balancing AI difficulty and variety
  - Testing diverse NPC playstyles

- **Audio & Visual Assets**
  - Additional sound effects for game actions
  - UI polish and visual consistency
  - Card animation improvements

#### 📋 Planned Features (Post-MVP)
- Advanced statistics and analytics
- More sophisticated NPC conversation context
- Tournament mode with increasing blinds
- Additional poker variants
- Improved visual theme and animations

### Development Goals
The primary goal remains **educational** - to gain hands-on experience integrating LLM technology within a Godot game engine while building a functional poker application. The project demonstrates:
- Local LLM integration in game development
- Signal-based architecture in Godot
- State machine patterns for game logic
- Asynchronous operation handling
- Test-driven development with GdUnit4

## How to Play

### Getting Started
1. **Generate NPCs**: On the Start Screen, click "Generate" buttons to create up to 8 unique AI opponents. Each generation takes a moment as the LLM creates a unique backstory and personality.

2. **Select an Opponent**: Click "Play" on any generated NPC card to start a match against that opponent.

3. **Play Poker**: 
   - You and the NPC both start with 1000 credits
   - Blinds are fixed at 10/20 (small/big)
   - Use the betting controls to Fold, Check/Call, or Raise
   - Drag the slider to set your raise amount
   - Watch as community cards are revealed (Flop, Turn, River)

4. **Chat with NPCs**:
   - Type messages in the chat box during your turn
   - NPCs will respond in-character based on their personality
   - View conversation history in the "History" tab
   - Chat responses appear during the NPC's turn

5. **Win the Match**: Play continues until either you or the NPC runs out of credits. The winner is recorded in the statistics.

### Tips
- Pay attention to NPC betting patterns to discover their personality (aggressive, cautious, bluff-heavy)
- Engage in conversation to get a feel for the NPC's character
- Check the Statistics screen to track your performance against different NPCs
- Delete NPCs you don't enjoy and generate new ones to find interesting opponents

## License
This project is currently unlicensed. All rights are reserved.
