# LLM Generation Update - Trimodal Random Trait Generation

## Overview
Refactor NPC generation to use **pre-generated random traits** with a trimodal distribution instead of asking the LLM to generate personality values. The LLM will only generate name and backstory based on provided trait categories.

## User Requirements
1. **Distribution**: Trimodal (explicitly favor LOW/MEDIUM/HIGH ranges)
2. **Independence**: All three traits (aggression, bluffing, risk_aversion) are completely independent
3. **Categories**: Map float values to human-readable categories in the prompt

## Trait Category Mapping

### Aggression
- **LOW (0.0-0.3)**: Passive player, checks and calls often, rarely raises
- **MEDIUM (0.4-0.6)**: Balanced approach, selective aggression when appropriate
- **HIGH (0.7-1.0)**: Very aggressive, frequently raises and re-raises

### Bluffing
- **LOW (0.0-0.3)**: Honest player, only bets with strong hands
- **MEDIUM (0.4-0.6)**: Bluffs occasionally in good spots
- **HIGH (0.7-1.0)**: Frequent bluffer, deceptive and unpredictable

### Risk Aversion
- **LOW (0.0-0.3)**: Reckless gambler, willing to risk chips freely
- **MEDIUM (0.4-0.6)**: Calculated risk-taker, balanced approach
- **HIGH (0.7-1.0)**: Very cautious, protective of chip stack

## Implementation Plan

### Phase 1: Add Random Trait Generation Function

**File**: `scripts/NPCGenerator.gd`

**New Functions**:

```gdscript
func _generate_random_traits() -> Dictionary:
	"""
	Generate random personality traits with trimodal distribution.
	Each trait is independently assigned to LOW, MEDIUM, or HIGH range.
	Returns exact float values within the selected range.
	"""
	return {
		"aggression": _generate_trimodal_value(),
		"bluffing": _generate_trimodal_value(),
		"risk_aversion": _generate_trimodal_value()
	}

func _generate_trimodal_value() -> float:
	"""
	Generate a random value using trimodal distribution.
	33.3% chance each for LOW (0.0-0.3), MEDIUM (0.4-0.6), HIGH (0.7-1.0).
	Returns a uniform random value within the selected range.
	"""
	var range_selector = randf()  # 0.0 to 1.0
	
	if range_selector < 0.333:
		# LOW range: 0.0 to 0.3
		return randf_range(0.0, 0.3)
	elif range_selector < 0.666:
		# MEDIUM range: 0.4 to 0.6
		return randf_range(0.4, 0.6)
	else:
		# HIGH range: 0.7 to 1.0
		return randf_range(0.7, 1.0)

func _get_trait_category(value: float) -> String:
	"""
	Map a trait value to its category (LOW, MEDIUM, HIGH).
	Used for generating the LLM prompt.
	"""
	if value <= 0.3:
		return "LOW"
	elif value <= 0.6:
		return "MEDIUM"
	else:
		return "HIGH"

func _get_trait_description(trait_name: String, category: String) -> String:
	"""
	Get human-readable description for a trait category.
	Used in the LLM prompt to provide context.
	"""
	var descriptions = {
		"aggression": {
			"LOW": "Passive player who checks and calls often, rarely raises",
			"MEDIUM": "Balanced approach with selective aggression when appropriate",
			"HIGH": "Very aggressive player who frequently raises and re-raises"
		},
		"bluffing": {
			"LOW": "Honest player who only bets with strong hands",
			"MEDIUM": "Bluffs occasionally in good spots",
			"HIGH": "Frequent bluffer who is deceptive and unpredictable"
		},
		"risk_aversion": {
			"LOW": "Reckless gambler willing to risk chips freely",
			"MEDIUM": "Calculated risk-taker with a balanced approach",
			"HIGH": "Very cautious and protective of chip stack"
		}
	}
	
	return descriptions[trait_name][category]
```

### Phase 2: Update JSON Schema

**File**: `scripts/NPCGenerator.gd`

**Modify**: `_get_npc_json_schema()` function

**Changes**:
- Remove `aggression`, `bluffing`, and `risk_aversion` properties
- Keep only `name` and `backstory` as required fields
- Simplify schema to reflect new structure

**Note**: Uses Phi-3-mini-4k-instruct-q4 model for generation (same model used for chat with different optimization parameters).

```gdscript
func _get_npc_json_schema() -> String:
	"""
	Returns the simplified JSON schema for NPC generation.
	Only name and backstory are generated by the LLM.
	Personality traits are pre-generated randomly.
	"""
	var schema = {
		"type": "object",
		"properties": {
			"name": {
				"type": "string",
				"description": "Character name (e.g., Commander, Captain, Salvager, Dr. Chen, etc.)"
			},
			"backstory": {
				"type": "string",
				"description": "3-4 sentence backstory that explains their personality traits and poker style"
			}
		},
		"required": ["name", "backstory"]
	}
	
	return JSON.stringify(schema)
```

### Phase 3: Create New Prompt Template

**File**: `prompts/npc_generation.txt`

**New Content**:

```
<|user|>
You are creating a unique character for a space-themed poker game. The character has specific personality traits that affect their poker playing style. Your task is to create a name and backstory that EXPLAINS and JUSTIFIES these exact traits.

**CHARACTER PERSONALITY TRAITS:**

**AGGRESSION: {aggression_category}**
{aggression_description}
Exact value: {aggression_value}

**BLUFFING: {bluffing_category}**
{bluffing_description}
Exact value: {bluffing_value}

**RISK AVERSION: {risk_aversion_category}**
{risk_aversion_description}
Exact value: {risk_aversion_value}

**YOUR TASK:**

1. **Create a creative name** that fits the space-themed setting (examples: military ranks like "Commander Voss" or "Captain Chen", occupation titles like "The Salvager" or "Broker Kaine", planet origins like "Kepler" or "Zenith", or unique monikers like "Doc" or "Ace")

2. **Write a 3-4 sentence backstory** that:
   - Describes their profession or background (examples: asteroid miner, cargo smuggler, xenobiologist, corporate spy, naval officer, deep-space trader, bounty hunter, station engineer, diplomatic courier, salvage operator, AI researcher, colony administrator)
   - Explains HOW and WHY they developed these specific poker personality traits
   - Includes a defining characteristic or past event that shaped their playing style
   - Describes their current situation or what brought them to this poker game

**IMPORTANT**: The backstory must clearly explain why this character has {aggression_category} aggression, {bluffing_category} bluffing tendency, and {risk_aversion_category} risk aversion. Make the connection between their life experiences and their poker behavior explicit and believable.

**Example of trait-justified backstory**:
- HIGH aggression + LOW bluffing + MEDIUM risk: "Commander Voss spent 20 years in the Frontier Fleet, leading aggressive boarding actions against pirate vessels. She learned poker from her crew during long patrols, and her direct military approach translates to an aggressive betting styleâ€”she believes in applying pressure and forcing opponents to fold. However, her naval training emphasizes honesty and discipline, making her a straightforward player who rarely bluffs. She calculates her risks carefully, understanding when to push and when to retreat."

Output your response as valid JSON with these exact fields:
{
  "name": "character name here",
  "backstory": "3-4 sentence backstory here"
}<|end|>
<|assistant|>
```

**Note**: The placeholders `{aggression_category}`, `{aggression_description}`, etc. will be replaced with actual values during runtime.

### Phase 4: Modify Generation Flow

**File**: `scripts/NPCGenerator.gd`

**Function**: `generate_npc()`

**Changes**:

```gdscript
func generate_npc(slot_index: int, empty_slot_template: Dictionary):
	"""
	Initiate NPC generation for a specific slot.
	Generates random traits first, then asks LLM for name and backstory.
	
	Args:
		slot_index: The slot index to generate for
		empty_slot_template: Empty slot structure to use as base
	"""
	if _is_generating:
		print("NPCGenerator Warning: Generation already in progress")
		return
	
	print("NPCGenerator: Starting NPC generation for slot ", slot_index)
	
	# Store the slot index and initialize temp data
	_current_slot_index = slot_index
	_is_generating = true
	_temp_npc_data = empty_slot_template.duplicate(true)
	
	# STEP 1: Generate random personality traits with trimodal distribution
	var random_traits = _generate_random_traits()
	_temp_npc_data["aggression"] = random_traits["aggression"]
	_temp_npc_data["bluffing"] = random_traits["bluffing"]
	_temp_npc_data["risk_aversion"] = random_traits["risk_aversion"]
	
	print("NPCGenerator: Generated random traits:")
	print("  Aggression: ", random_traits["aggression"], " (", _get_trait_category(random_traits["aggression"]), ")")
	print("  Bluffing: ", random_traits["bluffing"], " (", _get_trait_category(random_traits["bluffing"]), ")")
	print("  Risk Aversion: ", random_traits["risk_aversion"], " (", _get_trait_category(random_traits["risk_aversion"]), ")")
	
	# Connect to LLM signals
	if not LLMClient.response_received.is_connected(_on_llm_response):
		LLMClient.response_received.connect(_on_llm_response)
	
	if not LLMClient.error_occurred.is_connected(_on_llm_error):
		LLMClient.error_occurred.connect(_on_llm_error)
	
	# STEP 2: Create prompt with pre-generated trait values
	var prompt = _create_prompt_with_traits(random_traits)
	
	# STEP 3: Define simplified JSON schema (only name + backstory)
	var json_schema = _get_npc_json_schema()
	
	# STEP 4: Send to LLM with JSON schema
	var success = LLMClient.send_prompt(prompt, json_schema, LLMClient.ModelConfig.NPC_GENERATION)
	
	if not success:
		_on_generation_failed("Failed to initiate NPC generation")
```

**New Helper Function**:

```gdscript
func _create_prompt_with_traits(traits: Dictionary) -> String:
	"""
	Load the prompt template and replace placeholders with actual trait values.
	"""
	var template = _load_prompt_file("npc_generation.txt")
	
	if template == "":
		print("NPCGenerator Error: Failed to load prompt template")
		return ""
	
	# Get categories for each trait
	var agg_category = _get_trait_category(traits["aggression"])
	var bluff_category = _get_trait_category(traits["bluffing"])
	var risk_category = _get_trait_category(traits["risk_aversion"])
	
	# Replace all placeholders
	var prompt = template.replace("{aggression_category}", agg_category)
	prompt = prompt.replace("{aggression_description}", _get_trait_description("aggression", agg_category))
	prompt = prompt.replace("{aggression_value}", str(traits["aggression"]).pad_decimals(2))
	
	prompt = prompt.replace("{bluffing_category}", bluff_category)
	prompt = prompt.replace("{bluffing_description}", _get_trait_description("bluffing", bluff_category))
	prompt = prompt.replace("{bluffing_value}", str(traits["bluffing"]).pad_decimals(2))
	
	prompt = prompt.replace("{risk_aversion_category}", risk_category)
	prompt = prompt.replace("{risk_aversion_description}", _get_trait_description("risk_aversion", risk_category))
	prompt = prompt.replace("{risk_aversion_value}", str(traits["risk_aversion"]).pad_decimals(2))
	
	return prompt
```

### Phase 5: Simplify Response Parsing

**File**: `scripts/NPCGenerator.gd`

**Function**: `_parse_npc_json_response()`

**Changes**:
- Remove validation for aggression, bluffing, risk_aversion fields
- Remove clamping logic (traits already validated)
- Only validate name and backstory

```gdscript
func _parse_npc_json_response(response: String) -> Dictionary:
	"""
	Parse simplified JSON response from LLM (only name and backstory).
	Personality traits were already generated randomly before LLM call.
	"""
	# Clean the response by extracting JSON between Phi-3 special tokens
	var cleaned_response = _extract_json_from_response(response)
	
	var json = JSON.new()
	var parse_result = json.parse(cleaned_response)
	
	if parse_result != OK:
		print("NPCGenerator Error: JSON parse error at line ", json.get_error_line(), ": ", json.get_error_message())
		print("Raw response: ", response)
		print("Cleaned response: ", cleaned_response)
		return {}
	
	var data = json.data
	
	# Validate required fields
	if not data is Dictionary:
		print("NPCGenerator Error: LLM response is not a JSON object")
		return {}
	
	if not data.has("name") or data["name"] == "":
		print("NPCGenerator Error: Missing or empty 'name' field")
		return {}
	
	if not data.has("backstory") or data["backstory"] == "":
		print("NPCGenerator Error: Missing or empty 'backstory' field")
		return {}
	
	# Extract and validate only name and backstory
	var result = {}
	result["name"] = str(data["name"]).strip_edges()
	result["backstory"] = str(data["backstory"]).strip_edges()
	
	# Trim backstory to reasonable length
	if result["backstory"].length() > 1000:
		result["backstory"] = result["backstory"].substr(0, 997) + "..."
	
	return result
```

**Function**: `_on_llm_response()`

**Changes**:
- Only extract name and backstory from parsed data
- Traits are already in _temp_npc_data from generation phase

```gdscript
func _on_llm_response(response_text: String):
	"""
	Handle LLM response for NPC generation (simplified JSON format).
	Only extracts name and backstory; traits were pre-generated.
	"""
	print("NPCGenerator: LLM response received, parsing JSON...")
	
	var parsed_data = _parse_npc_json_response(response_text)
	
	if parsed_data.is_empty():
		_on_generation_failed("Failed to parse NPC data from LLM JSON response")
		return
	
	# Store only name and backstory from LLM
	# Traits (aggression, bluffing, risk_aversion) were already set during generate_npc()
	_temp_npc_data["name"] = parsed_data["name"]
	_temp_npc_data["backstory"] = parsed_data["backstory"]
	
	print("NPCGenerator: NPC generation complete!")
	print("  Name: ", _temp_npc_data["name"])
	print("  Backstory: ", _temp_npc_data["backstory"].substr(0, 100), "...")
	print("  Aggression: ", _temp_npc_data["aggression"], " (", _get_trait_category(_temp_npc_data["aggression"]), ")")
	print("  Bluffing: ", _temp_npc_data["bluffing"], " (", _get_trait_category(_temp_npc_data["bluffing"]), ")")
	print("  Risk Aversion: ", _temp_npc_data["risk_aversion"], " (", _get_trait_category(_temp_npc_data["risk_aversion"]), ")")
	
	# Emit success signal with complete data
	var slot_index = _current_slot_index
	var npc_data = _temp_npc_data.duplicate(true)
	
	# Cleanup before emitting signal
	_cleanup_generation()
	
	# Notify completion
	generation_completed.emit(slot_index, npc_data)
```

## File Changes Summary

### Modified Files
1. **`scripts/NPCGenerator.gd`**
   - Add `_generate_random_traits()` function
   - Add `_generate_trimodal_value()` function
   - Add `_get_trait_category()` function
   - Add `_get_trait_description()` function
   - Add `_create_prompt_with_traits()` function
   - Modify `generate_npc()` to generate traits first
   - Simplify `_get_npc_json_schema()` (remove trait fields)
   - Simplify `_parse_npc_json_response()` (only validate name/backstory)
   - Update `_on_llm_response()` to only extract name/backstory

2. **`prompts/npc_generation.txt`**
   - Complete rewrite with new template structure
   - Include placeholder variables for trait injection
   - Add detailed guidance for trait-justified backstories

### No Changes Required
- `scripts/GameManager.gd` - Data structure remains the same
- `scripts/LLMClient.gd` - No changes needed
- Save file format - Unchanged (still stores all 5 fields)

## Expected Benefits

### 1. More Distinctive NPCs
- Trimodal distribution ensures traits cluster at extremes (LOW/HIGH)
- Players will immediately notice NPC playing styles
- Eliminates "all NPCs play the same" problem caused by 0.5 clustering

### 2. Better Backstory Quality
- LLM has clear constraints to work with
- Forces backstory to justify specific traits
- More creative and varied character concepts

### 3. Improved Generation Reliability
- Simpler JSON schema (2 fields vs 5)
- Less parsing complexity
- Fewer opportunities for LLM to generate invalid data

### 4. Faster Generation
- LLM generates fewer fields
- Trait generation is instant (no LLM call)
- Reduced token usage per generation

### 5. Gameplay Impact
```
Example trait combinations and their gameplay feel:

HIGH aggression + HIGH bluffing + LOW risk_aversion
â†’ "Maniac" archetype - unpredictable, dangerous opponent

LOW aggression + LOW bluffing + HIGH risk_aversion  
â†’ "Rock" archetype - tight, predictable, waits for premium hands

MEDIUM across all traits
â†’ "Balanced" archetype - still possible but less common (11% chance)

HIGH aggression + LOW bluffing + MEDIUM risk_aversion
â†’ "Solid aggressive" archetype - strong player, bets when strong
```

## Testing Strategy

### 1. Trait Distribution Verification
Generate 100 NPCs and verify:

**Per-trait distribution (each trait independently):**
- ~33% of aggression values in LOW range (0.0-0.3)
- ~33% of aggression values in MEDIUM range (0.4-0.6)
- ~33% of aggression values in HIGH range (0.7-1.0)
- Same distribution applies to bluffing and risk_aversion traits

**Overall character profiles (combined traits):**
- Only ~4% should have all three traits in MEDIUM range (0.33Â³ â‰ˆ 3.7%)
- ~96% should have at least one extreme trait (LOW or HIGH)
- ~30% should have all extreme traits with no MEDIUM values (0.67Â³ â‰ˆ 30%)
- The "perfectly balanced player" archetype should be rare, as intended

This distribution ensures most NPCs have distinctive, noticeable playing styles rather than clustering around middle values.

### 2. Independence Check
Verify that trait values are uncorrelated:
- All 27 combinations (3Â³) should appear over a large sample
- No bias toward specific trait pairings (e.g., HIGH aggression shouldn't correlate with HIGH bluffing)

### 3. Backstory Quality Review
Manually review 10-20 generated NPCs to ensure:
- Backstories logically explain the assigned traits
- Character concepts are diverse
- No generic/repetitive patterns

### 4. LLM Parsing Success Rate
Track generation failures:
- Should be lower than current implementation
- Simpler schema should reduce parsing errors

## Migration Notes

### Backward Compatibility
- Existing save files are fully compatible
- No data migration needed
- New NPCs will have distributed traits, old NPCs unchanged

### Rollback Plan
If issues arise:
1. Keep old `npc_generation.txt` as `npc_generation_old.txt` backup
2. Git commit after each phase for easy reversion
3. Old JSON schema is documented in this file for reference

## Implementation Checklist

- [ ] Phase 1: Add random trait generation functions to NPCGenerator.gd
- [ ] Phase 2: Update JSON schema to only require name/backstory
- [ ] Phase 3: Create new prompt template with placeholders
- [ ] Phase 4: Modify generate_npc() to generate traits first
- [ ] Phase 5: Simplify response parsing logic
- [ ] Testing: Generate 10 test NPCs and verify trait distribution
- [ ] Testing: Verify backstories match assigned traits
- [ ] Testing: Check JSON parsing success rate
- [ ] Documentation: Update if needed (per project policy)

## Estimated Impact

- **Code changes**: ~200 lines modified/added in NPCGenerator.gd
- **New prompt template**: ~50 lines
- **Testing time**: 30-60 minutes
- **Risk level**: LOW (isolated to NPCGenerator, easy rollback)
- **User-visible improvement**: HIGH (much more distinctive NPCs)
